<?xml version="1.0" encoding="UTF-8"?>
<project name="IDM Report Generator" default="all" basedir="..">

    <target name="all" depends="setup">
        <!-- Call the Spiffy UI build -->
        <ant antfile="${build.base}/external/spiffyui/build/build.xml" 
             dir="${build.base}/external/spiffyui">
            <property name="spiffy.www" value="${root}/bin/www"/>
            <property name="spiffy.classes" value="${root}/bin/classes"/>
        </ant>
        
        <antcall target="HTMLProps"/>
             
        <antcall target="gwt-compile">
            <param name="gwttarget" value="com.novell.spsample.index"/>
        </antcall>
        
        <antcall target="compile"/>
        
        <antcall target="javadoc"/>
        
        <antcall target="package" />
    </target>
    
    <target name="setup">
        <property environment="env"/>

        <!-- These are all the project relative paths.  Please add new paths
             here so they are easier to find when they change. -->
        <condition property="build.base" value="${env.SPSAMPLE_BASE}" else="${basedir}">
          <isset property="${env.env.SPSAMPLE_BASE}"/>
        </condition>
        <property name="root" location="${build.base}"/>
        <property name="build" location="${build.base}/build"/>

        <property name="tomcat.home"  location="${build.base}/../rpt_spiffy/external/tomcat"/>
        
        <mkdir dir="${root}/bin"/>
        <mkdir dir="${root}/bin/www"/>
        <mkdir dir="${root}/dist"/>
    </target>
    
    <target name="HTMLProps" depends="setup">
        <taskdef name="htmlprops" classname="com.novell.spiffyui.build.HTMLPropertiesTask">
            <classpath>
                <pathelement location="${root}/external/spiffyui/build/lib/closuretask.jar"/>
            </classpath>
        </taskdef>
        
        <mkdir dir="${root}/bin/classes/com/novell/spsample/client"/>
        
        <htmlprops properties="${root}/bin/classes/com/novell/spsample/client/SPSampleStrings.properties">
            <fileset dir="${root}/src/com/novell/spsample/client" includes="**/*.html" />
        </htmlprops>
        
    </target>
    
    <!-- This target calls the GWT compiler inline and
         moves the files around so we get the compiled
         GWT without the directory with the package name -->
    <target name="gwt-compile" description="use gwt's compiler">
        <java classname="com.google.gwt.dev.Compiler"
            fork="true" failonerror="true" maxmemory="256m">
            <arg value="-style"/>
            <arg value="PRETTY"/>
            <arg value="-war"/>
            <arg value="${root}/bin/www"/>
            <arg value="${gwttarget}"/>
            <classpath>
                <pathelement location="${root}/src"/>
                <pathelement location="${root}/external/spiffyui/src"/>
                <pathelement location="${root}/bin/classes"/>
                <fileset dir="${build}/lib">
                    <include name="**/*.jar"/>
                </fileset>
                <pathelement path="${java.class.path}"/>
            </classpath>
        </java>
        
        <!-- GWT compiles files into a directory with the same
             name as the package.  We want to strip that off. 
             If we add more GWT modules to the project we'll 
             need to skip this step for them. -->
        <move todir="${root}/bin/www" failonerror="false">
            <fileset dir="${root}/bin/www/com.novell.spsample.index" includes="**/*" />
        </move>
        
        <delete dir="${root}/bin/www/com.novell.spsample.index" />
        
    </target>
    
    <target name="compile">
        <mkdir dir="${root}/bin/classes"/>
        
        <!-- Compile all the Java -->
        <javac srcdir="${root}/src/com/novell/spsample/server" destdir="${root}/bin/classes" 
               target="1.5" source="1.5" debug="true" deprecation="yes"
               includeantruntime="false">
            <compilerarg value="-Xlint" />
            <classpath>
                <fileset dir="${root}/build/lib">
                    <include name="**/*.jar"/>
                </fileset>
                <fileset dir="${root}/external/spiffyui/lib">
                    <include name="**/*.jar"/>
                </fileset>
                <pathelement path="${java.class.path}"/>
            </classpath>
        </javac>
    </target>
    
    <target name="package" description="package everything into a WAR">
        <!-- Create the distribution directory -->
        <delete file="${root}/dist/spsample.war" />
        <war destfile="${root}/dist/spsample.war" webxml="${root}/web.xml">
            <fileset dir="${root}/bin/www"/>
            <zipfileset dir="${root}/js" prefix="js" >
                <include name="**/*.js"/>
            </zipfileset>
            <zipfileset dir="${root}/bin/classes" prefix="WEB-INF/classes" >
                <include name="**/*.class"/>
            </zipfileset>
            
            <!-- We need to add the JARs to support the spiffy framework to
                 our WAR file -->
            <zipfileset dir="${root}/external/spiffyui/lib" prefix="WEB-INF/lib" >
                <include name="**/*.jar"/>
            </zipfileset>     
        </war>
    </target>
    
    <target name="javadoc">
        <mkdir dir="${root}/bin/www/javadoc"/>
        
        <javadoc destdir="${root}/bin/www/javadoc"
                 author="false"
                 version="true"
                 use="true"
                 windowtitle="Spiffy UI Framework API">
            <packageset dir="${root}/external/spiffyui/src" defaultexcludes="yes">
                <include name="com/novell/spiffyui/**"/>
            </packageset>
        </javadoc>
    </target>

    <target name="tomcat.setup" depends="setup,tomcat.deploycheck">
        <fail message="The spsample.war file is missing.  You must build before you can deploy.">
            <condition>
                <not>
                    <available file="${root}/dist/spsample.war"/>
                </not>
            </condition>
        </fail>

        <echo message="catalina-ant.jar: ${tomcat.home}/lib/catalina-ant.jar" />
        <property file="${build}/tomcat.properties"/>
        <taskdef file="${build}/tomcatTasks.properties">
            <classpath>
                <pathelement path="${tomcat.home}/lib/catalina-ant.jar"/>
            </classpath>
        </taskdef>
    </target>

    <target name="tomcat.deploycheck">
        <condition property="spsample.is.deployed">
            <available file="${tomcat.home}/webapps/spsample.war"/>
        </condition>
    </target>

    <target name="tomcat.undeploy" if="spsample.is.deployed">
        <undeploy url="${tomcat.manager.url}"
            username="${tomcat.username}"
            password="${tomcat.password}"
            path="/spsample"/>
    </target>

    <target name="deploy" depends="tomcat.setup,tomcat.undeploy">
        <deploy url="${tomcat.manager.url}"
            username="${tomcat.username}"
            password="${tomcat.password}"
            path="/spsample"
            war="file:${root}/dist/spsample.war"/>
    </target>
    
    <target name="clean" depends="setup">
        <!-- Call the Spiffy UI build -->
        <ant antfile="${build.base}/external/spiffyui/build/build.xml" 
             dir="${build.base}/external/spiffyui"
             target="spiffy.clean">
            <property name="spiffy.www" value="${root}/bin/www"/>
            <property name="spiffy.classes" value="${root}/bin/classes"/>
        </ant>
        
        <delete dir="${root}/dist"/>
        <delete dir="${root}/bin"/>
    </target>
</project>
